# 4. CPU의 동작 원리
## ALU와 제어장치
### ALU
- CPU 내에서 계산을 담당하는 장치이다.
- 레지스터를 통해 피 연산자를 받아들이고, 제어장치 제어 신호로부터 수행할 연산을 받아들인다.
- 연산 결과로 특정 숫자나 문자, 메모리 주소를 일시적으로 레지스터에 저장.

#### 레지스터에 저장하는 이유
- CPU가 메모리에 접근하는 속도 < CPU가 레지스터에 접근하는 속도
- 메모리에 저장하면 프로그램 실행 속도가 늦어질 수 있다.

#### Flag
- ALU 연산 결과에 대한 추가적인 상태 정보
- Flag 레지스터에 저장된다.

#### Flag의 종류
1. 부호 플래그 : 연산한 결과의 부호를 나타낸다.
2. 제로 플래그 : 연산 결과가 0인지 여부를 나타낸다.
3. 캐리 플래그 : 연산 결과 올림수나 빌림수가 발생했는지를 나타낸다.
4. 오버플로우 플래그 : 오버플로우가 발생했는지를 나타낸다.
5. 인터럽트 플래그 : 인터럽트가 가능한지를 나타낸다.
6. 슈퍼바이저 플래그 : 커널 모드인지, 사용자 모드인지 나타낸다.

## 제어장치
### 제어장치의 역할
- 제어장치는 클럭 신호를 받아들인다.
    - 클럭 : 모든 부품을 일사불란하게 움직일 수 있게하는 시간 단위로 '해석해야 할 명령어'를 받아들인다.
- CPU가 해석해야 할 명령어는 명령어 레지스터라에 저장된다. 명령어 레지스터로 부터 해석할 명령어를 받아들이고 해석한 뒤, 제어신호를 발생시켜 수행해야할 내용을 알려준다.
- 플래그 레지스터 속 플래그 값을 받아들인다.
    - 제어장치는 플래그 값을 받아들이고 이를 참고하여 제어신호 발생
- 시스템 버스, 그 중에서 제어 버스로 전달된 제어 신호를 받아들인다. CPU 뿐만 아니라 입출력장치를 비롯한 CPU 외부 장치도 발생시킬 수 있다. 외부로부터 전달된 제어 신호를 받아들이기도 한다.
- CPU 외부전달
    - 메모리 : 저장된 값을 읽거나 새로운 값을 쓰고싶을 때 제어신호를 보낸다
    - 입출력장치 : 입출력장치의 값을 읽거나 입출력장치에 새로운 값을 쓰고싶을 때
- CPU 내부 전달


## 레지스터
### 반드시 알아야 할 레지스터
1. 프로그램 카운터 - 메모리에서 읽어 들일 명령어의 주소를 저장.
2. 명령어 레지스터 - 방금 메모리에서 읽어 들인 명령어를 저장하는 레지스터
제어장치가 명령어를 받아들이고 해석한 뒤 제어신호를 보낸다.
3. 메모리 주소 레지스터 - 메모리의 주소를 저장하는 레지스터. CPU가 읽어 들이고자 하는 주소 값을 주소 버스로 보낼 때 메모리 주소 레지스터를 거친다.
4. 메모리 버퍼 레지스터 - 메모리에 쓰고 싶은 값이나 메모리로부터 전달받은 값은 메모리 버퍼 레지스터를 거친다.
5. 플래그 레지스터 - 연산 결과 또는 CPU 상태에 대한 부가적인 정보를 저장하는 레지스터
6. 범용 레지스터 - 다양하고 일반적인 상황에서 자유롭게 사용할 수 있는 레지스터.
데이터와 주소를 모두 저장할 수 있다.
7. 스택 포인터 
8. 베이스 레지스터


### 특정 레지스터의 주소 지정 방식
1. 스택 주소 지정 방식 - 스택과 스택 포인터를 이용한 주소 지정 방식
    - 스택의 꼭대기를 가리키는 레지스터
    - 스택에 마지막으로 저장한 값의 위치를 저장하는 레지스터
2. 변위 주소 방식 - 오퍼랜드의 필드의 값(변위)과 특정 레지스터의 값을 더하여 유효 주소를 얻어내는 지정 방식
    - 명령어가 연산코드, 레지스터, 오퍼랜드로 이루어 지고 어떤 레지스터의 값과 더할지를 나타내는 레지스터 필드, 주소를 담고있는 오퍼랜드 필드가 있다.
3. 상대 주소 지정 방식 - 오퍼랜드와 프로그램 카운터의 값을 더하여 유효 줏를 얻는 방식
    - 분기하여 특정 주소의 코드를 실행될 때 사용
4. 베이스 레지스터 주소 지정 방식
    - 베이스 레지스터 = 기준 주소
    - 오퍼랜드 = 기준 주소로 부터 떨어진 거리
    - 베이스 레지스터 속 기준 주소로 부터 얼마나 떨어져 있는 주소에 접근할 것인지를 연산하여 유효 주소를 얻어낸다.


### 명령어 사이클 
- 프로그램 속 각각의 명령어들리 명령어 사이클이 반복되며 실행하는 것 (하나의 명령어 처리가 되는 주기)
- 인출 사이클 : 메모리에 있는 명령어를 CPU로 가지고 오는 단계
- 실행 사이클 : CPU로 가져온 명령어를 실행하는 단계

### 인터럽트
- CPU의 작업을 방해하는 신호
1. 동기 인터럽트(예외) : CPU에 의해 발생하는 인터럽트로 CPU가 명령어들을 수행하다가 예상치 못한 상황에 마주쳤을 때, CPU가 실행하는 프로그래밍상 오류와 같은 예외적인 상황
2. 비동기 인터럽트(하드웨어 인터럽트) : 입출력 장치에 의해 발생하는 인터럽트 알림과 같은 인터럽트

### 하드웨어 인터럽트 처리 순서
1. 입 출력 장치 CPU에 인터럽트 요청 신호를 보냄
2. CPU는 실행 사이클이 끝나고 명령어를 인출하기 전 인터럽트 여부 확인
3. CPU는 인터럽트 요청을 확인하고 인터럽트 플래그를 통해 인터럽트를 발아드릴 수 있는지 여부 확인
4. 인터럽트를 받아드릴 수 있다면 CPU는 지금까지의 작업을 백업 함
5. CPU는 인터럽트 벡터를 참조하여 인터럽트 서비스 루틴을 실행
6. 인터럽트 서비스 루틴 실행이 끝나면 (4)에서 백업해 둔 작업을 복구하여 실행 재개

### 인터럽트 요청 신호 
- CPU의 정상적인 실행 흐름을 끊기 전 CPU에 끼어들어도 되는지 물어보는 신호
### 인터럽트 플래그 
- 하드웨어가 인터럽트를 받아드릴지, 무시할 지 결정하는 플래그
### 인터럽트 서비스 루틴 
- 인터럽트를 처리하기 위한 프로그램
### 인터럽트 벡터 
- 인터럽트 서비스 루틴을 식별하기 위한 정보

### 정리 
- CPU가 인터럽트를 처리한다 는 말은 '인터럽트 서비스 루틴을 실행하고, 본래 수행하던 작업으로 다시 돌아온다'
- CPU가 인터럽트 서비스 루틴을 실행 하려면 인터럽트 서비스 루틴의 시작 주소를 알아야 하는데 이는 인터럽트 벡터를 통해 알 수 있다.
- 폴트 - 예외가 처리한 직후 예외가 발생한 명령어부터 실행을 재개하는 예외
- 트랩 - 예외를 처리한 후 예외가 발생한 명령어의 다음 명령어부터 실행을 재개
- 디버깅 : 프로그램 개발 중에 발생한 문제를 진단하고 해결하기 위한 작업
