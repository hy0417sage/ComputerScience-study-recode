# 가상 메모리

## 연속 메모리 할당
- 프로세스에 연속적인 메모리 공간을 할당하는 방식을 **'연속 메모리 할당 방식'** 이라고 한다.
- 프로세스를 메모리에 연속적으로 할당하는 방식은 두가지 문제를 내포하고 있다.
    1. 외부 단편화
    2. 물리 메모리 보다 큰 프로세스를 실행할 수 없다
    - 이 두 문제를 한번에 해결하는 방법! -> 가상메모리 *페이징 기법!*
- 연속적인 메모리를 할당할 때 고려해야 하는 부분을 알아보자

### 스와핑
- 메모리에서 사용되지 않는 일부 프로세스를 보조기억장치로 내보내고 실행할 프로세스를 메모리로 들여보내는 메모리 관리 기법을 **'스와핑'**이라고 한다.
1. 프로세스들이 쫓겨나는 보조기억장치의 일부 영역을 '스왑 영역'이라고 한다.
2. 횬자 실행되지 않는 프로세스가 메모리에서 스와 영역으로 옮겨지는 것을 "'스왑 아웃'이라고 한다.
3. 반대로 스왑 영역에 있던 프로세스가 다시 메모리로 옮겨오는 것을 '스왑 인' 이라고 한다.

### 메모리 할당
- 비어 있는 메모리 공간에 프로세스를 연속적으로 할당하는 방식
1. 최초 적합 : 운영체제가 메모리 내의 빈 공간을 순서대로 검색하다가 적재할 수 있는 공간을 발견하면 그 공간에 프로세스를 배치하는 방식
2. 최적 적합 : 운영체제가 빈 공간을 모두 검색해 본 후, 프로세스가 적재 될 수 있는 공간 중 가장 작은 공간에 프로세스를 배치하는 방식
3. 최악 적합 : 운영체제가 빈 공간을 모두 검색해 본 후, 프로세스에 적재될 수 있는 가장 큰 공간에 프로새스를 배치하는 방식

### 외부 단편화
- 프로세스를 연속적으로 배치하는 연속 메모리 할당은 '외부 단편화' 문제를 내보하고 있다.
- 외부 단편화가 생긴 근본적인 이유는 각기 다른 프로세스가 메모리에 연속적으로 할당되었기 때문!
- 외부 단편화 문제를 해결할 수 있는 대표적인 방안으로 '메모리를 압축'하는 방법이 있다.
    - 압축은 여기저기 흩어져 있는 빈 공간들을 하나로 모으는 방식으로 메모리 내에 저장된 프로세스를 적당히 배치시켜 하나의 큰 공간으로 만드는 것
    - 하지만 단점이 많다.
    1. 빈 공간들을 하나로 모으는 동안 시스템은 하던 일을 중지
    2. 메모리에 있는 내용을 옮기는 작업은 많은 오버헤드를 야기
    3. 어떤 프로세스를 어떻게 움직여야 오버 헤드를 최소화하며 압축할 수 있는지 명확한 방법 결정 어려움
- 외부 단편화 문제의 또다른 해결방안으로 가상 메모리 기법의 **'페이징 기법'**이 있다. 가장 대중적이고 많이 사용됨!

#### 외부 단편화 발생
1. 프로세스들이 연속적으로 할당되는 환경에서는 프로세스들이 실행되고 종료되기를 반복하며 메모리 사이의 빈 공간이 생긴다.
2. 프로세스 바깥에 생기는 이러한 빈 공간들은 분명 빈 공간들 이지만 그 공간보다 큰 프로세스를 적재하기 어려운 상황을 초래하고, 결국 메모리 낭비로 이어진다.
- 이런 현상을 외부 단편화라고 함

## 가상 메모리
- '가상 메모리'는 실행하고자 하는 프로그램을 일부만 메모리에 적재하여 실제 메모리 크기보다 더 큰 프로세스를 실행할 수 있게 하는 기술이다.
- 가상 메모리 관리 기법에는 '페이징', '세그멘테이션'이 있다.
- 그 중 페이징 기법은 물리 메모리보다 더 큰 프로세스를 실행할 수 있을 뿐만 아니라 외부 단편화 문제를 해결할 수 있다.

### 페이징 기법
- 메모리와 프로세스를 일정 단위로 자르고, 이를 메모리에 불연속적으로 할당할 수만 있다면 외부 단편화는 발생하지 않는다 -> 이러한 기법이 페이징 기법
- 페이징은 프로세스의 노리 주소 공간을 '페이지'라는 이렁한 단위로 자르고,
- 메모리 물리 주소 공간을 '프레임'이라는 페이지와 동일한 크기의 일정한 단위로 다른 뒤 페이지를 프레임에 할당하는 가상 메모리 기법
- 페이징 시스템에서의 스왑 아웃은 '페이지 아웃' 스왑 인은 '페이지 인'이라고 부른다.

## 페이지 테이블
- 페이징 시스템은 프로세스가 비록 물리 주소에 불연속 적으로 배치되더라도 CPU에서 바라본 논리 주소에서는 연속적으로 배치되도록 페이지 테이블을 이용한다.
- 페이지 테이블은 페이지 번호를 이용해 페이지가 적재된 프레임을 찾을 수 있다.
- CPU 내의 페이지 테이블 베이스 레지스터(PTBR)는 각 프로세스의 페이지 테이블이 적재된 주소를 가리키고 있다.
- 하지만 이렇게 페이지 테이블을 메모리에 두면 메모리 접근시간이 두배로 늘어나 CPU 곁(일반적으로 MMU 내에) TLB 라는 페이지 테이블의 캐시 메모리를 둔다.
    - CPU가 발생한 논리 주소에 대한 페이지 번호가 TLB에 있을 경우 TLB 히트라고 한다.
    - CPU가 발생한 논리 주소에 대한 페이지 번호가 TLB에 없을 경우 TLB 미스라고 한다.

### 페이징에서의 주소 변환
- 페이징 시스템에서는 모든 논리 주소가 기본적으로 **페이지 번호**와 **변위**로 이루어져 있다.
- '페이지 번호'는 말 그대로 접근하고자 하는 페이지 번호로 페이지 테이블에서 해당 페이지 번호를 찾으면 페이지가 어떤 프레임에 할당 되었는지 알 수 있다.
- '변위'는 접근하려는 주소가 프레임의 시작 번지로부터 얼만큼 떨어져 있는지를 알기 위한 정보이다. 
- 즉, 논리주소(페이지 번호, 변위)는 페이지 테이블을 통해 물리주소(프레임 번호, 변위)로 변환된다.

## 페이지 테이블 엔트리
- 페이지 테이블의 각각의 행동들을 '페이지 테이블 엔트리'라고 한다.
- 페이지 번호, 프레임 번호말고 다른 중요한 정보들이 있으며 (1)유효 비트, (2)보호 비트, (3)참조비트, (4)수정 비트 등이 있다.

### 유효 비트
- 유효비트는 해당 페이지가 메모리에 적재 되어있는지 여부를 알려주는 비트로, 페이지가 메모리에 적재되어있지 않으면 '페이지 폴트'가 발생한다.
- 페이지가 메모리에 적제 되어있다면 유효비트가 1, 페이지가 메모리에 적재 되어있다면 유효비트 0이 된다.

#### CPU가 페이지 폴드를 처리하는 과정(하드웨어 인터럽트 처리과정과 유사)
1. CPU는 기본의 작업 내역을 백업한다.
2. 페에지 폴트 처리 루틴을 실행한다.
3. 페이지 처리 루틴은 원하는 페이지로 메모리를 가져온 뒤 유효 비트를 1로 변경해 준다.
4. 페이지 폴트를 처리했다면 이제 CPU는 해당 페이지에 접근할 수 있다.

### 보호 비트
- 페이지에 접근할 권한을 제한하여 페이지를 보호하는 비트이다.
- 보호 비트를 통해 해당 페이지가 읽고 쓰기가 모두 가능한 페이지인지, 혹은 읽기만 가능한 페이지인지를 나타낼 수 있다.
- 비트가 0일 경우 이 페이지는 읽기만 가능한 페이지, 1일 경우 읽고 쓰기가 가능한 페이지

### 참조 비트
- 적재 이후 CPU가 이 페이지에 접근한 적이 있는지 여부를 나타낸다. (0, 1)

### 수정 비트
- 해당 페이지에 데이터를 쓴 적이 있는지 없는지 수정 여부를 알려준다. ('더티비트' 라고도 함)
- 변경된적이 있는 페이지(1) 변경된적이 없는 페이지(0) 를 나타낸다.
- 수정된 적잉 있는 페이지가 스완 아웃이 될 경우 변경된 값을 보조기억장치에 기록하는 작업이 추가 되어야 하여 페이지 테이블 엔트리에 수정 비트를 둔다.

### 페이징의 이점 : 프로세스 간에 페이지를 공유할 수 있다.
- 프로세스간 페이지를 공유하는 사례의 대표적인 예시는 '쓰기 시 복사'가 있다.
- 운영체제에서 fork 시스템을 호출하면, 부모 프로세스 다른 영역에 복제 -> 자식 프로세스에서 수정하는데 이 방법은 시간이 많이 걸려 이 복사 작업은 프로세스 생성 시간을 늦출 뿐만 아니라 불필요한 메모리 낭비를 야기한다. 
- 부모 프로세스 혹은 자식 프로세스 둘 중 하나가 페이지에 쓰기 작업을 하면 그 순간 페이지가 별도의 공간으로 복제된다. 
- 각 프로세스는 자신의 고유한 페이지가 할당된 프로임을 가리킨다. 이것이 쓰기 시 복사!
- 이러한 쓰기 시 복사를 통해 프로세스 생성 시간을 줄이고 메모리 공간 절약도 가능하다.

### 계층적 페이징 
- 프로세스를 이루는 모든 페이지 테이블 엔트리를 항상 메모리에 유지하지 않을 수 있는 방법
- 페이지 테이블을 페이징 하여 여러 단계의 페이지를 두는 방식이다.
- 프로세스의 페이지 테이블을 여러 개의 페이지로 자르고, 바깥쪽에 페이지 테이블을 하나 더 두어 잘린 페이지 테이블의 페이지를 가리키게 하는 방식
- 논리 주소를 토대로 주소변환은
1. 바깥 페이지 번호를 통해 페이지 테이블의 페이지를 찾기
2. 페이지 테이블의 페이지를 통해 프레임 번호를 찾고 변위를 더함으로서 물리 주소 얻기
